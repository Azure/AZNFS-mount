#!/bin/bash

# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
# --------------------------------------------------------------------------------------------

# Exit on error.
set -e

# Set appropriate permissions.
chmod 0755 /opt/microsoft/aznfs/
chmod 0755 /usr/sbin/aznfswatchdog
chmod 0755 /opt/microsoft/aznfs/mountscript.sh
chmod 0644 /opt/microsoft/aznfs/common.sh

# Set suid bit for mount.aznfs to allow mount for non-super user.
chmod 4755 /sbin/mount.aznfs

# Create a random byte source for deterministic shuffling of IP addresses.
set +e
if [ ! -s /opt/microsoft/aznfs/randbytes ]; then
        dd if=/dev/urandom of=/opt/microsoft/aznfs/randbytes bs=256 count=1
fi
if [ ! -s /opt/microsoft/aznfs/randbytes ]; then
        uuidgen > /opt/microsoft/aznfs/randbytes
fi
if [ ! -s /opt/microsoft/aznfs/randbytes ]; then
        date | md5sum | awk '{print $1}' > /opt/microsoft/aznfs/randbytes
fi
if [ ! -s /opt/microsoft/aznfs/randbytes ]; then
        date > /opt/microsoft/aznfs/randbytes
fi
chattr +i /opt/microsoft/aznfs/randbytes
set -e

#
# If we are not booted with systemd that most likely means we are in a
# container that's being created. Avoid doing any changes that need
# systemd to be running, just enable the aznfswatchdog service so that
# it gets started when the container is booted with systemd.
#
if [ "$init" == "systemd" ]; then
    # Reload systemd configuration to ensure any changes take effect.
    systemctl daemon-reload

    # Enable the 'aznfswatchdog' service to start on boot.
    systemctl enable aznfswatchdog
    
    # Start the 'aznfswatchdog' service.
    systemctl start aznfswatchdog
else
    # Enable the 'aznfswatchdog' service to start on boot (not starting it since init is not systemd).
    systemctl enable aznfswatchdog
    echo "aznfswatchdog enabled but not started, will start when system is booted with systemd init!"
fi