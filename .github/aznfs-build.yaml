parameters:
  - name: publish_artifacts
    displayName: 'Publish Artifacts to Linux Repos'
    type: boolean
    default: false

  - name: draft
    displayName: 'Post as Draft Release'
    type: boolean
    default: false

  - name: prerelease
    displayName: 'Post as PreRelease'
    type: boolean
    default: false

  - name: update_version
    displayName: 'Update Version'
    type: boolean
    default: false

  - name: versionName
    displayName: "Version Name"
    type: string
    default: "0.0.0"

# Do not trigger this pipeline automatically
trigger:
  - none

# Do not trigger this pipeline by pull requests
pr:
  - none

stages:
  - stage: Build packages
    displayName: "Build and Package Artifacts"
    jobs:
      - job: Build_Package
        displayName: "Build and Package"
        pool:
          vmImage: "ubuntu-latest"

        variables:
          - name: root_dir
            value: '$(System.DefaultWorkingDirectory)'
          - name: work_dir
            value: '$(System.DefaultWorkingDirectory)/AZNFS-mount'

        steps:
          # - checkout: self

          - script: |
              git clone --branch personal/sroghanchi/pipeline https://github.com/Azure/AZNFS-mount
            displayName: 'Checkout Code'
            workingDirectory: $(root_dir)

          # - script: |
          #     echo "Building version ${{ parameters.versionName }}"
          #   displayName: "Print Version Info"

          - script: |
              sudo apt-get update
              sudo apt install -y gcc-aarch64-linux-gnu
            displayName: "Install Cross-Compile Tools"

          - script: |
              export RELEASE_NUMBER=${{ parameters.versionName }}
              export STG_DIR=$(work_dir)
              export SOURCE_DIR=$(work_dir)
              chmod +x $(work_dir)/release/generate_package.sh
              $(work_dir)/release/generate_package.sh
            displayName: "Run Package Script"

          - script: |
              cp $(work_dir)/deb/aznfs-${{ parameters.versionName }}-1_amd64.deb $(Build.ArtifactStagingDirectory)
              cp $(work_dir)/rpm/root/rpmbuild/RPMS/x86_64/aznfs-${{ parameters.versionName }}-1.x86_64.rpm $(Build.ArtifactStagingDirectory)
              cp $(work_dir)/suse/root/rpmbuild/RPMS/x86_64/aznfs_sles-${{ parameters.versionName }}-1.x86_64.rpm $(Build.ArtifactStagingDirectory)
              cp $(work_dir)/stunnel/root/rpmbuild/RPMS/x86_64/aznfs_stunnel_custom-${{ parameters.versionName }}-1.x86_64.rpm $(Build.ArtifactStagingDirectory)
              echo "Listing Built Files..."
              ls -R $(Build.ArtifactStagingDirectory)
            displayName: "List Build Outputs"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              artifactName: 'aznfs-temp'

  - stage: ReleaseArtifacts
    jobs:
      - job: SignArtifacts
        timeoutInMinutes: 120

        pool:
          vmImage: 'ubuntu-20.04'
        
        steps:
          - checkout: none

          # download artifacts that need to be published
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'aznfs-temp'
              downloadPath: $(Build.ArtifactStagingDirectory)

          - script: |
              sudo ls -lRt $(Build.ArtifactStagingDirectory)
              # md5sum $(Build.ArtifactStagingDirectory)/aznfs-temp/*.deb
              # md5sum $(Build.ArtifactStagingDirectory)/aznfs-temp/*.rpm
            displayName: 'List Artifacts'

          - script: |
              sudo apt-get update
              wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb 
              sudo dpkg -i packages-microsoft-prod.deb 
              sudo apt update 
              sudo apt install apt-transport-https -y
              sudo apt install dotnet-sdk-3.1 -y
            displayName: "Update dependencies"

          - task: EsrpCodeSigning@5
            displayName: 'ESRP CodeSigning MI'
            inputs:
              ConnectedServiceName: 'Azure AZNFS'
              AppRegistrationClientId: '0eebccb1-4bcb-445e-bf3f-fa7a8fa5fd7d'
              AppRegistrationTenantId: '33e01921-4d64-4f8c-a055-5bdaffd5e33d'
              # EsrpClientId: '0eebccb1-4bcb-445e-bf3f-fa7a8fa5fd7d'

              UseMSIAuthentication: true
              AuthAKVName: 'aznfs-keyvault'
              AuthSignCertName: 'aznfs-cert'

              FolderPath: $(Build.ArtifactStagingDirectory)/aznfs-temp
              Pattern: '*.rpm, *.deb'
              SessionTimeout: 90
              ServiceEndpointUrl: 'https://api.esrp.microsoft.com/api/v2'
              MaxConcurrency: 25
              signConfigType: inlineSignParams
              VerboseLogin: true
              inlineOperation: |
                [
                {
                  "KeyCode": "CP-450779-Pgp",
                  "OperationCode": "LinuxSign",
                  "ToolName": "sign",
                  "ToolVersion": "1.0",
                  "Parameters": {}
                }
                ]

           # Validate signed images have md5sum changed
          - script: |
              chmod 755 $(Build.ArtifactStagingDirectory)/aznfs-temp/*.deb
              chmod 755 $(Build.ArtifactStagingDirectory)/aznfs-temp/*.rpm
              # rm -rf $(Build.ArtifactStagingDirectory)/aznfs-temp/*.md
              mv $(Build.ArtifactStagingDirectory)/aznfs-temp/* $(Build.ArtifactStagingDirectory)/
              rm -rf $(Build.ArtifactStagingDirectory)/aznfs-temp/
            displayName: 'Make Artifacts executable'

          - script: |
              sudo ls -lRt $(Build.ArtifactStagingDirectory)
              # md5sum $(Build.ArtifactStagingDirectory)/*.deb
            displayName: 'List Signed Artifacts'
          
          # Push signed images to artifact directory
          - task: PublishBuildArtifacts@1
            inputs:
              artifactName: 'aznfs-signed'
            displayName: 'Publish Signed Artifacts'

  - stage: PublishArtifacts
    dependsOn: ReleaseArtifacts
    condition: succeeded('ReleaseArtifacts')
    jobs:
      - job: PublishArtifacts
        timeoutInMinutes: 120
      
        pool:
          vmImage: 'ubuntu-20.04'

        variables:
            - name: root_dir
              value: '$(System.DefaultWorkingDirectory)'

        steps:
          - checkout: none

          - task: PipAuthenticate@1
            inputs:
              artifactFeeds: 'One/aznfs'
          - script: pip install pmc-cli
            displayName: 'Install pmc-cli'

          # Download artifacts that need to be published
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Signed Artifacts'
            inputs:
             artifactName: 'aznfs-signed'
             downloadPath: $(Build.ArtifactStagingDirectory)

          - script: |
              sudo ls -lRt $(Build.ArtifactStagingDirectory)
            displayName: 'List Signed Artifacts'

          - script: |
              wget https://raw.githubusercontent.com/Azure/AZNFS-mount/refs/heads/main/release/packages.csv -O packages.csv
              cat ./packages.csv
            displayName: 'Fetch packages.csv'
            workingDirectory: $(Build.ArtifactStagingDirectory)/


          - task: AzureCLI@2
            inputs:
              addSpnToEnvironment: true
              azureSubscription: 'Azure AZNFS'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                  pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" repo list --limit 1
                  # echo "##vso[task.setvariable variable=idToken;issecret=true]$idToken"
                  # echo "##vso[task.setvariable variable=tenantId]$tenantId"
                  # echo "##vso[task.setvariable variable=servicePrincipalId]$servicePrincipalId"

                  # upload packages
                  pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" package upload $(Build.ArtifactStagingDirectory)/aznfs-signed

                  #################################### get package id #####################################

                  aznfsDeb=`pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" --id-only package upload $(Build.ArtifactStagingDirectory)/aznfs-signed/aznfs*-1_amd64.deb`
                  echo "AZNFS DEB Package ID: $aznfsDeb"

                  aznfsRpm=`pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" --id-only package upload $(Build.ArtifactStagingDirectory)/aznfs-signed/aznfs-*-1.x86_64.rpm`
                  echo "AZNFS DEB Package ID: $aznfsRpm"

                  aznfsRpmSles=`pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" --id-only package upload $(Build.ArtifactStagingDirectory)/aznfs-signed/aznfs_sles-*-1.x86_64.rpm`
                  echo "AZNFS DEB Package ID: $aznfsRpmSles"

                  aznfsRpmStunnel=`pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" --id-only package upload $(Build.ArtifactStagingDirectory)/aznfs-signed/aznfs_stunnel_custom-*-1.x86_64.rpm`
                  echo "AZNFS DEB Package ID: $aznfsRpmStunnel"

                  ################################### Add uploaded packages to its repository ######################################

                  while IFS=, read -r distro PackageArchType repoName releaseName; do

                    echo "Uploading packages for $distro"
                    pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" repo package update --add-packages ${!PackageArchType} $repoName $releaseName
                  done < <(tail -n +3 $(Build.ArtifactStagingDirectory)/packages.csv)

                  #################################### Publish the repositories #####################################

                  while IFS=, read -r distro PackageArchType repoName releaseName; do
                    echo "Repository Name: $repoName"

                    echo "Publishing for $distro"
                    pmc --base-url "https://pmc-ingest.trafficmanager.net/api/v4" repo publish $repoName
                  done < <(tail -n +3 $(Build.ArtifactStagingDirectory)/packages.csv)



