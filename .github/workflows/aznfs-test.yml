name: Test AZNFS

on:
  workflow_dispatch:
    inputs:
      versionName:
        description: 'Version Name'
        required: true
      storageAccounts:
        description: 'Space-separated Storage Accounts'
        required: true

env:
  RELEASE_NUMBER: ${{ github.event.inputs.versionName }}
  STORAGE_ACCOUNTS: ${{ github.event.inputs.storageAccounts }}

jobs:
  run_shellcheck:
    name: Shellcheck for AZNFS
    runs-on: self-hosted-ubuntu22
    steps:
      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Install AZNFS
        shell: bash
        run: |
          export AZNFS_NONINTERACTIVE_INSTALL=1
          sudo wget -O - -q "https://github.com/Azure/AZNFS-mount/releases/download/${{ github.event.inputs.versionName }}/aznfs_install.sh" | bash
      - name: Run Shellcheck on Scripts
        shell: bash
        run: |
          declare -a files_to_check=(
            "/src/aznfswatchdog"
            "/src/mountscript.sh"
            "/lib/common.sh"
            "/scripts/aznfs_install.sh"
          )
          for file in "${files_to_check[@]}"; do
            echo "=== Checking $file for errors ==="

            full_file_path="$GITHUB_WORKSPACE$file"
            if output=$(shellcheck --severity=error "$full_file_path"); then
              echo "No errors found in $file."
            else
              echo "$output"
            fi
          done

  test_aznfs_ubuntu18:
    name: Test AZNFS - Ubuntu 18
    runs-on: self-hosted-ubuntu18
    needs: run_shellcheck
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'ubuntu'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  test_aznfs_ubuntu20:
    name: Test AZNFS - Ubuntu 20
    runs-on: self-hosted-ubuntu20
    needs: test_aznfs_ubuntu18
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'ubuntu'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  test_aznfs_ubuntu22:
    name: Test AZNFS - Ubuntu 22
    runs-on: self-hosted-ubuntu22
    needs: test_aznfs_ubuntu20
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine 
        with:
          RUNS_ON: 'ubuntu'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  test_aznfs_centos7:
    name: Test AZNFS - CentOS 7
    runs-on: self-hosted-centos7
    needs: test_aznfs_ubuntu22
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'centos'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh
          
  test_aznfs_centos8:
    name: Test AZNFS - CentOS 8
    runs-on: self-hosted-centos8
    needs: test_aznfs_centos7
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'centos'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  test_aznfs_suse15:
    name: Test AZNFS - openSUSE 15
    runs-on: self-hosted-suse15
    needs: test_aznfs_centos8
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'sles'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  test_aznfs_redhat7:
    name: Test AZNFS - Red Hat 7
    runs-on: self-hosted-redhat7
    needs: test_aznfs_suse15
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'rhel'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  test_aznfs_redhat8:
    name: Test AZNFS - Red Hat 8
    runs-on: self-hosted-redhat8
    needs: test_aznfs_redhat7
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'rhel'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  test_aznfs_redhat9:
    name: Test AZNFS - Red Hat 9
    runs-on: self-hosted-redhat9
    needs: test_aznfs_redhat8
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: AZNFS Prep Machine
        uses: ./.github/actions/aznfs-prep-machine
        with:
          RUNS_ON: 'rhel'
      - name: Run Test Script
        shell: bash
        run: |
          chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
          $GITHUB_WORKSPACE/testing/testscript.sh

  # test_aznfs_rocky8:
  #   name: Test AZNFS - Rocky Linux 8
  #   runs-on: self-hosted-rocky8
  #   needs: test_aznfs_redhat9
  #   steps:
  #     - name: Checkout Repository
  #       uses: actions/checkout@v3
      # - name: AZNFS Prep Machine
      #   uses: ./.github/actions/aznfs-prep-machine
  #     - name: Run Test Script
  #       shell: bash
  #       run: |
  #         chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
  #         $GITHUB_WORKSPACE/testing/testscript.sh
  # test_aznfs_rocky9:
  #   name: Test AZNFS - Rocky Linux 9
  #   runs-on: self-hosted-rocky9
  #   needs: test_aznfs_rocky8
  #   steps:
  #     - name: Checkout Repository
  #       uses: actions/checkout@v3
      # - name: AZNFS Prep Machine
      #   uses: ./.github/actions/aznfs-prep-machine
  #     - name: Run Test Script
  #       shell: bash
  #       run: |
  #         chmod +x $GITHUB_WORKSPACE/testing/testscript.sh
  #         $GITHUB_WORKSPACE/testing/testscript.sh
